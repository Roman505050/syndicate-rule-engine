name: ci-for-build-and-tests

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]
  pull_request_review:
    types: [ submitted ]
  workflow_dispatch:

jobs:
  check_modified_files:
    if: >
      github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository ||
      github.event_name == 'pull_request_review' && github.event.review.state == 'approved' && github.event.pull_request.head.repo.full_name != github.repository
    name: Check modified files in directories
    runs-on: ubuntu-latest
    outputs:
      cli_files_changes_found: ${{ steps.check_cli_files.outputs.changes_found }}
      src_files_changes_found: ${{ steps.check_src_files.outputs.changes_found }}
      patches_files_changes_found: ${{ steps.check_patches_files.outputs.changes_found }}
      patch_version: ${{ steps.check_patch.outputs.version }}
      patch_exists: ${{ steps.check_patch.outputs.exists }}
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}


    - name: Check modified files in cli directory
      id: check_cli_files
      shell: bash
      run: |
        ls -la ./.github/workflows/
        git fetch origin ${{ github.event.pull_request.base.sha }}
        changed_files=$(git diff --name-only ${{ github.event.pull_request.base.sha }})
        echo "Changed files: ${changed_files}"
        checked_directory="cli/"
        for file in ${changed_files}
        do
          if [[ ${file} == ${checked_directory}* ]]
          then
            echo "Target directory was modified."
            echo "changes_found=true" >>$GITHUB_OUTPUT
            exit 0
          fi
        done
        echo "Target directory was not modified."
        echo "changes_found=false" >>$GITHUB_OUTPUT
        echo "dist=/tmp/bavp/dist" >>$GITHUB_OUTPUT

    - name: Check modified files in src directory
      id: check_src_files
      shell: bash
      run: |
        git fetch origin ${{ github.event.pull_request.base.sha }}
        changed_files=$(git diff --name-only ${{ github.event.pull_request.base.sha }})
        echo "Changed files: ${changed_files}"
        checked_directory="src/"
        for file in ${changed_files}
        do
          if [[ ${file} == ${checked_directory}* ]]
          then
            echo "Target directory was modified."
            echo "changes_found=true" >>$GITHUB_OUTPUT
            exit 0
          fi
        done
        echo "Target directory was not modified."
        echo "changes_found=false" >>$GITHUB_OUTPUT
        echo "dist=/tmp/bavp/dist" >>$GITHUB_OUTPUT

    - name: Check modified files in patches directory
      id: check_patches_files
      shell: bash
      run: |
        git fetch origin ${{ github.event.pull_request.base.sha }}
        changed_files=$(git diff --name-only ${{ github.event.pull_request.base.sha }})
        echo "Changed files: ${changed_files}"
        checked_directory="patches/"
        for file in ${changed_files}
        do
          if [[ ${file} == ${checked_directory}* ]]
          then
            echo "Target directory was modified."
            echo "changes_found=true" >>$GITHUB_OUTPUT
            exit 0
          fi
        done
        echo "Target directory was not modified."
        echo "changes_found=false" >>$GITHUB_OUTPUT

    - name: Check patch version and existence
      id: check_patch
      run: |
        VERSION=$(grep -E '^version\s*=' pyproject.toml | sed -E "s/^version\s*=\s*[\"']?([^\"']+)[\"']?/\1/" | tr -d ' ')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Detected version: $VERSION"
        
        if [ -d "patches/$VERSION" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "Patch found for version $VERSION"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "No patch found for version $VERSION"
        fi

  build_package:
    name: Build CLI package
    needs: check_modified_files
    if: ${{ needs.check_modified_files.outputs.cli_files_changes_found == 'true' }}
    uses: ./.github/workflows/build-and-check-python-package.yml
    with:
      path: ./cli

  tests:
    name: Run Python tests
    needs: check_modified_files
    if: ${{ needs.check_modified_files.outputs.src_files_changes_found == 'true' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version:
          - "3.10"
#          - "3.11"  # TODO: if it's uncommented the pipeline fails because it tries to upload coverage.xml twice for each version and there is a conflict. Should be fixed
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}
    - name: Install uv and set the python version
      uses: astral-sh/setup-uv@v5
      with:
        python-version: ${{ matrix.python-version }}
        enable-cache: true
        cache-dependency-glob: "uv.lock"
    - name: Install dependencies
      run: |
        uv sync --all-extras --all-groups --prerelease=allow
    - name: Run tests with Python ${{ matrix.python-version }}
      run: |
        uv run --frozen pytest --verbose --cov=src/ --cov-report=term --cov-report=xml:coverage.xml --junitxml=report.xml -n auto
    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage.xml
        retention-days: 1
    - name: Upload test report
      uses: actions/upload-artifact@v4
      with:
        name: test-report
        path: report.xml
        retention-days: 1

  build_and_validate_patch:
    name: Build and validate patch Docker image
    needs: check_modified_files
    if: >
      needs.check_modified_files.outputs.patch_exists == 'true' &&
      needs.check_modified_files.outputs.patches_files_changes_found == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./patches/${{ needs.check_modified_files.outputs.patch_version }}/Dockerfile
          build-args: |
            PATCH_VERSION=${{ needs.check_modified_files.outputs.patch_version }}
          tags: |
            patch-test:${{ needs.check_modified_files.outputs.patch_version }}
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true

      - name: Validate patch (isolated)
        run: |
          VERSION="${{ needs.check_modified_files.outputs.patch_version }}"
          echo "Running isolated validation in Docker container..."
          docker run --rm patch-test:$VERSION --isolated
